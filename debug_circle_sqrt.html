<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Circle Sqrt Issue</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    
    <!-- MathJax 2.7.5 Configuration (Same as main app) -->
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                ignoreClass: "tex2jax_ignore",
                processClass: "tex2jax_process",
                preview: "none"
            },
            TeX: {
                equationNumbers: { autoNumber: "AMS" },
                extensions: ["AMSmath.js", "AMSsymbols.js", "cancel.js"]
            },
            showMathMenu: false,
            showProcessingMessages: true,
            messageStyle: "normal"
        });
        
        // Enhanced error handling
        MathJax.Hub.Register.MessageHook("Math Processing Error", function (message) {
            console.error("MathJax Error: ", message);
            alert("MathJax Error detected: " + JSON.stringify(message));
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
    <div class="container mt-4">
        <h1>Debug Circle Sqrt Issue</h1>
        
        <div class="alert alert-warning">
            <strong>Debug Mode:</strong> This page is designed to identify why sqrt expressions show as raw code.
        </div>
        
        <!-- Test 1: Exact circle tool content -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>Test 1: Exact Circle Tool Content</h3>
            </div>
            <div class="card-body" id="circle-tool-content">
                <div class="circle-tool">
                    <h4>Definición como lugar geométrico:</h4>
                    <p class="mb-3">Se llama círculo al lugar geométrico de todos los puntos $P(x,y)$ que se mueven en 
                    el plano, de forma que su distancia a un punto fijo $C(h,k)$ (llamado centro) es siempre constante. 
                    La constante se llama radio $r > 0$.</p>
                    
                    <div class="math-equation mb-3">
                        <strong>Definición formal:</strong> 
                        $$d(P,C) = r$$
                        $$\sqrt{(x-h)^2 + (y-k)^2} = r$$
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Test 2: Raw source inspection -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>Test 2: Raw HTML Source</h3>
            </div>
            <div class="card-body">
                <button class="btn btn-info mb-3" onclick="showRawHTML()">Show Raw HTML of Circle Content</button>
                <pre id="raw-html-display" class="bg-light p-3" style="display:none;"></pre>
            </div>
        </div>
        
        <!-- Test 3: Step by step validation -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>Test 3: Step by Step Validation</h3>
            </div>
            <div class="card-body">
                <button class="btn btn-primary mb-2" onclick="step1()">Step 1: Apply validateAndFixSqrtFormulas</button>
                <button class="btn btn-primary mb-2" onclick="step2()">Step 2: Apply validateAndFixAllMathFormulasWithAlternatives</button>
                <button class="btn btn-primary mb-2" onclick="step3()">Step 3: Reprocess MathJax</button>
                <button class="btn btn-success mb-2" onclick="allSteps()">All Steps at Once</button>
                
                <div id="step-content" class="mt-3">
                    <div class="math-equation">
                        <strong>Test formula:</strong> 
                        $$\sqrt{(x-h)^2 + (y-k)^2} = r$$
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Console log -->
        <div class="card">
            <div class="card-header">
                <h3>Console Log</h3>
            </div>
            <div class="card-body">
                <div id="console-log" class="bg-dark text-light p-3" style="font-family: monospace; max-height: 300px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <!-- Load validation functions -->
    <script src="js/script1.js"></script>
    
    <script>
        // Enhanced console logging
        const originalConsoleLog = console.log;
        const originalConsoleWarn = console.warn;
        const originalConsoleError = console.error;
        
        function logToPage(message, type = 'log') {
            const logDiv = document.getElementById('console-log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-danger' : type === 'warn' ? 'text-warning' : 'text-light';
            logDiv.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            logToPage(args.join(' '));
        };
        
        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            logToPage(args.join(' '), 'warn');
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            logToPage(args.join(' '), 'error');
        };
        
        function showRawHTML() {
            const content = document.getElementById('circle-tool-content');
            const rawDisplay = document.getElementById('raw-html-display');
            rawDisplay.textContent = content.innerHTML;
            rawDisplay.style.display = 'block';
        }
        
        function step1() {
            console.log('=== STEP 1: validateAndFixSqrtFormulas ===');
            const content = document.getElementById('step-content');
            if (window.app && window.app.validateAndFixSqrtFormulas) {
                window.app.validateAndFixSqrtFormulas(content);
                console.log('Step 1 completed');
            } else {
                console.error('validateAndFixSqrtFormulas not available');
            }
        }
        
        function step2() {
            console.log('=== STEP 2: validateAndFixAllMathFormulasWithAlternatives ===');
            const content = document.getElementById('step-content');
            if (window.app && window.app.validateAndFixAllMathFormulasWithAlternatives) {
                window.app.validateAndFixAllMathFormulasWithAlternatives(content);
                console.log('Step 2 completed');
            } else {
                console.error('validateAndFixAllMathFormulasWithAlternatives not available');
            }
        }
        
        function step3() {
            console.log('=== STEP 3: Reprocess MathJax ===');
            if (window.app && window.app.reprocessMathJaxGlobal) {
                window.app.reprocessMathJaxGlobal();
                console.log('Step 3 completed');
            } else if (typeof MathJax !== "undefined" && MathJax.Hub) {
                MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
                console.log('Step 3 completed (fallback)');
            } else {
                console.error('MathJax not available');
            }
        }
        
        function allSteps() {
            step1();
            setTimeout(() => {
                step2();
                setTimeout(() => {
                    step3();
                }, 100);
            }, 100);
        }
        
        // Check MathJax status
        MathJax.Hub.Register.StartupHook("End", function () {
            console.log("MathJax 2.7.5 is ready");
            console.log("App object available:", typeof window.app !== 'undefined');
            if (window.app) {
                console.log("Available app methods:", Object.keys(window.app).filter(key => typeof window.app[key] === 'function'));
            }
        });
        
        // Auto-analyze on page load
        window.addEventListener('load', function() {
            setTimeout(() => {
                console.log('=== PAGE LOADED - INITIAL ANALYSIS ===');
                showRawHTML();
            }, 2000);
        });
    </script>
</body>
</html>
