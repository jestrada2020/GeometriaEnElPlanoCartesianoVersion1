<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Corrección de Fórmulas begin{cases}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Configuración mejorada de MathJax -->
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                ignoreClass: "tex2jax_ignore",
                processClass: "tex2jax_process",
                preview: "none"
            },
            TeX: {
                equationNumbers: { autoNumber: "AMS" },
                extensions: ["AMSmath.js", "AMSsymbols.js", "cancel.js"],
                Macros: {
                    det: ["\\operatorname{det}"],
                    frac: ["\\dfrac{#1}{#2}", 2],
                    cos: ["\\cos"],
                    sin: ["\\sin"],
                    cosh: ["\\cosh"],
                    sinh: ["\\sinh"]
                },
                noErrors: {
                    inlineDelimiters: ["",""],
                    multiLine: true,
                    style: {
                        "font-size": "90%",
                        "text-align": "left",
                        "color": "black",
                        "padding": "1px 3px",
                        "border": "1px solid"
                    }
                }
            },
            "HTML-CSS": {
                scale: 90,
                linebreaks: { automatic: true },
                availableFonts: ["STIX", "TeX"],
                preferredFont: "TeX",
                webFont: "TeX",
                imageFont: null,
                matchFontHeight: false,
                styles: {
                    ".MathJax_Display": {
                        "text-align": "center !important",
                        "margin": "1em 0 !important"
                    },
                    ".MathJax": {
                        "color": "inherit !important"
                    }
                }
            },
            SVG: {
                scale: 90,
                linebreaks: { automatic: true },
                font: "TeX"
            },
            showMathMenu: false,
            showProcessingMessages: false,
            messageStyle: "none",
            skipStartupTypeset: false
        });
        
        // Configurar MathJax para re-renderizar cuando se actualice dinámicamente
        MathJax.Hub.Register.MessageHook("Math Processing Error", function (message) {
            console.warn("MathJax Error: ", message);
            // Intentar corregir errores comunes con cases
            if (message[1] && message[1].includes && (message[1].includes('cases') || message[1].includes('begin') || message[1].includes('end'))) {
                console.log("Detectado error con cases, intentando corrección automática");
                setTimeout(function() {
                    if (window.testFunctions && window.testFunctions.validateAndFixAllMathFormulas) {
                        window.testFunctions.validateAndFixAllMathFormulas(document.body);
                    }
                }, 100);
            }
            // Intentar corregir errores comunes con comandos matemáticos
            if (message[1] && message[1].includes && (message[1].includes('cosh') || message[1].includes('sinh') || message[1].includes('cos') || message[1].includes('sin'))) {
                console.log("Detectado error con comandos matemáticos, intentando corrección automática");
                setTimeout(function() {
                    if (window.testFunctions && window.testFunctions.validateAndFixAllMathFormulas) {
                        window.testFunctions.validateAndFixAllMathFormulas(document.body);
                    }
                }, 100);
            }
        });
        
        // Asegurar que MathJax esté listo
        MathJax.Hub.Register.StartupHook("End", function () {
            console.log("MathJax está listo");
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <style>
        .test-case {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .before {
            background-color: #fff3cd;
        }
        .after {
            background-color: #d4edda;
        }
        .problematic {
            background-color: #f8d7da;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>Test de Corrección de Fórmulas begin{cases}</h1>
        
        <div class="test-case before">
            <h3>Fórmulas correctas (deben renderizarse bien):</h3>
            <div class="math">$$\begin{cases} x = 3\cos(t) \\ y = 4\sin(t) \end{cases}$$</div>
            <div class="math">$$\begin{cases} x = 3\cosh(t) \\ y = 4\sinh(t) \end{cases}$$</div>
        </div>
        
        <div class="test-case problematic">
            <h3>Casos problemáticos que se deben corregir:</h3>
            <div class="math">$$\\begin{cases} x = 3\cos(t) \\ y = 4\sin(t) \\end{cases}$$</div>
            <div class="math">$$begin{cases} x = 3\cosh(t) \\ y = 4\sinh(t) end{cases}$$</div>
            <div class="math">$$\begin {cases} x = 3 \cosh (t) \\ y = 4 \sinh (t) \end {cases}$$</div>
            <div class="math">$$\\begin{cases} x = 3\\cosh(t) \\\\ y = 4\\sinh(t) \\end{cases}$$</div>
            <div class="math">$$\begin{cases} x = 3cosh(t) \\ y = 4sinh(t)$$</div>
        </div>
        
        <div class="test-case">
            <h3>Ecuaciones paramétricas complejas:</h3>
            <div class="parametric-equation">
                $$\begin{cases} 
                x = a\cos(t) + h \\ 
                y = b\sin(t) + k 
                \end{cases}$$
            </div>
            <div class="parametric-equation">
                $$\begin{cases} 
                x = a\cosh(t) + h \\ 
                y = b\sinh(t) + k 
                \end{cases}$$
            </div>
        </div>
        
        <button class="btn btn-primary" onclick="testFunctions.runTest()">Ejecutar Test de Corrección</button>
        <button class="btn btn-success" onclick="testFunctions.manualFix()">Aplicar Corrección Manual</button>
        <button class="btn btn-info" onclick="testFunctions.addDynamicCases()">Añadir Casos Dinámicos</button>
        
        <div id="test-results" class="mt-4"></div>
    </div>

    <script>
        window.testFunctions = {
            // Función específica para validar y corregir fórmulas con begin{cases} (copiada de script1.js)
            validateAndFixCasesFormulas: function(element) {
                if (!element) return;
                
                // Buscar todas las fórmulas matemáticas
                const mathElements = element.querySelectorAll('.math, .math-equation, .parametric-equation, [class*="math"]');
                
                mathElements.forEach(mathEl => {
                    let content = mathEl.innerHTML;
                    let originalContent = content;
                    
                    // Verificar si contiene begin{cases} en formato crudo o problemático
                    if (content.includes('\\begin{cases}') || content.includes('begin{cases}') || content.includes('\\end{cases}') || content.includes('end{cases}')) {
                        // Limpiar y corregir el formato
                        content = content
                            .replace(/\\\\begin\{cases\}/g, '\\begin{cases}')    // Corregir doble escape
                            .replace(/\\\\end\{cases\}/g, '\\end{cases}')        // Corregir doble escape
                            .replace(/(?<!\\)begin\{cases\}/g, '\\begin{cases}') // Añadir barra si falta
                            .replace(/(?<!\\)end\{cases\}/g, '\\end{cases}')     // Añadir barra si falta
                            .replace(/\\begin\s*\{cases\}/g, '\\begin{cases}')   // Eliminar espacios extra
                            .replace(/\\end\s*\{cases\}/g, '\\end{cases}')       // Eliminar espacios extra
                            .replace(/\\\\cosh/g, '\\cosh')                      // Corregir cosh
                            .replace(/\\\\sinh/g, '\\sinh')                      // Corregir sinh
                            .replace(/(?<!\\)cosh/g, '\\cosh')                   // Añadir barra si falta en cosh
                            .replace(/(?<!\\)sinh/g, '\\sinh');                  // Añadir barra si falta en sinh
                        
                        // Verificar que las estructuras de cases estén bien formadas
                        const beginMatches = (content.match(/\\begin\{cases\}/g) || []).length;
                        const endMatches = (content.match(/\\end\{cases\}/g) || []).length;
                        
                        if (beginMatches !== endMatches) {
                            console.warn('Estructura cases desbalanceada en fórmula matemática, intentando corrección');
                            // Intentar balancear añadiendo end{cases} faltante
                            const difference = beginMatches - endMatches;
                            if (difference > 0) {
                                content += '\\end{cases}'.repeat(difference);
                            }
                        }
                        
                        // Solo actualizar si hubo cambios
                        if (content !== originalContent) {
                            mathEl.innerHTML = content;
                            console.log('Fórmula cases corregida:', originalContent, '->', content);
                        }
                    }
                });
                
                // Re-procesar con MathJax si se hicieron correcciones
                if (typeof MathJax !== "undefined" && MathJax.Hub) {
                    setTimeout(() => {
                        MathJax.Hub.Queue(["Typeset", MathJax.Hub, element]);
                    }, 50);
                }
            },
            
            runTest: function() {
                const results = document.getElementById('test-results');
                results.innerHTML = '<h3>Ejecutando test...</h3>';
                
                // Simular casos problemáticos
                const testContainer = document.createElement('div');
                testContainer.innerHTML = `
                    <div class="test-case after">
                        <h4>Resultados del test:</h4>
                        <div class="math">$$\\\\begin{cases} x = 5\\cos(t) \\\\ y = 3\\sin(t) \\\\end{cases}$$</div>
                        <div class="math">$$begin{cases} x = 2\\cosh(t) \\\\ y = 4\\sinh(t) end{cases}$$</div>
                        <div class="math">$$\\begin {cases} x = \\cosh (t) \\\\ y = \\sinh (t) \\end {cases}$$</div>
                        <div class="parametric-equation">$$\\begin{cases} x = acosh(t) \\\\ y = bsinh(t)$$</div>
                    </div>
                `;
                
                results.appendChild(testContainer);
                
                // Aplicar corrección
                setTimeout(() => {
                    this.validateAndFixCasesFormulas(testContainer);
                    results.innerHTML += '<p class="text-success"><strong>Test completado. Revisa la consola para los logs de corrección.</strong></p>';
                }, 100);
            },
            
            manualFix: function() {
                this.validateAndFixCasesFormulas(document.body);
                alert('Corrección manual aplicada. Revisa la consola para los detalles.');
            },
            
            addDynamicCases: function() {
                const container = document.getElementById('test-results');
                const dynamicDiv = document.createElement('div');
                dynamicDiv.className = 'test-case';
                dynamicDiv.innerHTML = `
                    <h4>Casos añadidos dinámicamente:</h4>
                    <div class="math">$$\\begin{cases} x &= 3\\cosh(t) \\\\ y &= 4\\sinh(t) \\end{cases}$$</div>
                    <div class="parametric-equation">$$begin{cases} x = acosh(t) + h \\\\ y = bsinh(t) + k end{cases}$$</div>
                `;
                container.appendChild(dynamicDiv);
                
                // Aplicar corrección inmediatamente
                setTimeout(() => {
                    this.validateAndFixCasesFormulas(dynamicDiv);
                }, 100);
            }
        };
        
        // Ejecutar corrección automática al cargar la página
        window.addEventListener('load', function() {
            setTimeout(() => {
                testFunctions.validateAndFixCasesFormulas(document.body);
            }, 1000);
        });
    </script>
</body>
</html>
