<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Integral de Corrección de Fórmulas Matemáticas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Configuración mejorada de MathJax -->
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                ignoreClass: "tex2jax_ignore",
                processClass: "tex2jax_process",
                preview: "none"
            },
            TeX: {
                equationNumbers: { autoNumber: "AMS" },
                extensions: ["AMSmath.js", "AMSsymbols.js", "cancel.js"],
                Macros: {
                    det: ["\\operatorname{det}"],
                    frac: ["\\dfrac{#1}{#2}", 2],
                    cos: ["\\cos"],
                    sin: ["\\sin"],
                    cosh: ["\\cosh"],
                    sinh: ["\\sinh"]
                },
                noErrors: {
                    inlineDelimiters: ["",""],
                    multiLine: true,
                    style: {
                        "font-size": "90%",
                        "text-align": "left",
                        "color": "black",
                        "padding": "1px 3px",
                        "border": "1px solid"
                    }
                }
            },
            "HTML-CSS": {
                scale: 90,
                linebreaks: { automatic: true },
                availableFonts: ["STIX", "TeX"],
                preferredFont: "TeX",
                webFont: "TeX",
                imageFont: null,
                matchFontHeight: false,
                styles: {
                    ".MathJax_Display": {
                        "text-align": "center !important",
                        "margin": "1em 0 !important"
                    },
                    ".MathJax": {
                        "color": "inherit !important"
                    }
                }
            },
            SVG: {
                scale: 90,
                linebreaks: { automatic: true },
                font: "TeX"
            },
            showMathMenu: false,
            showProcessingMessages: false,
            messageStyle: "none",
            skipStartupTypeset: false
        });
        
        // Configurar MathJax para re-renderizar cuando se actualice dinámicamente
        MathJax.Hub.Register.MessageHook("Math Processing Error", function (message) {
            console.warn("MathJax Error: ", message);
            // Corrección automática integral
            setTimeout(function() {
                if (window.testFunctions && window.testFunctions.validateAndFixAllMathFormulas) {
                    window.testFunctions.validateAndFixAllMathFormulas(document.body);
                }
            }, 100);
        });
        
        // Asegurar que MathJax esté listo
        MathJax.Hub.Register.StartupHook("End", function () {
            console.log("MathJax está listo");
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <style>
        .test-case {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .correct { background-color: #d4edda; }
        .problematic { background-color: #f8d7da; }
        .fixed { background-color: #d1ecf1; }
        .test-section { margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>Test Integral de Corrección de Fórmulas Matemáticas</h1>
        <p class="lead">Este test verifica la corrección automática de sqrt, begin{cases}, y comandos matemáticos comunes.</p>
        
        <!-- Test 1: Fórmulas sqrt -->
        <div class="test-section">
            <h2>1. Fórmulas con sqrt</h2>
            <div class="test-case problematic">
                <h4>Casos problemáticos con sqrt:</h4>
                <div class="math">$$\\sqrt{25} = 5$$</div>
                <div class="math">$$sqrt{16} + 4$$</div>
                <div class="math">$$d = \sqrt {(x_1 - x_0)^2 + (y_1 - y_0)^2}$$</div>
                <div class="math">$$\sqrt{} = 0$$</div>
            </div>
        </div>

        <!-- Test 2: Fórmulas begin{cases} -->
        <div class="test-section">
            <h2>2. Fórmulas con begin{cases}</h2>
            <div class="test-case problematic">
                <h4>Casos problemáticos con cases:</h4>
                <div class="math">$$\\begin{cases} x = 3\\cos(t) \\\\ y = 4\\sin(t) \\end{cases}$$</div>
                <div class="math">$$begin{cases} x = 3\cosh(t) \\ y = 4\sinh(t) end{cases}$$</div>
                <div class="parametric-equation">$$\begin {cases} x = 3 \cosh (t) \\ y = 4 \sinh (t) \end {cases}$$</div>
            </div>
        </div>

        <!-- Test 3: Comandos matemáticos sin barra inicial -->
        <div class="test-section">
            <h2>3. Comandos matemáticos sin barra inicial</h2>
            <div class="test-case problematic">
                <h4>Casos problemáticos con comandos matemáticos:</h4>
                <div class="math">$$y = cos(x) + sin(x)$$</div>
                <div class="math">$$f(x) = cosh(x) - sinh(x)$$</div>
                <div class="math">$$g(x) = frac{1}{2} * ln(x)$$</div>
                <div class="math">$$h(x) = left( exp(x) + log(x) right)$$</div>
            </div>
        </div>

        <!-- Test 4: Casos mixtos complejos -->
        <div class="test-section">
            <h2>4. Casos mixtos complejos</h2>
            <div class="test-case problematic">
                <h4>Fórmulas complejas con múltiples problemas:</h4>
                <div class="math">$$\\begin{cases} x = a\\sqrt{cos(t)} \\\\ y = b\\sqrt{sin(t)} \\end{cases}$$</div>
                <div class="parametric-equation">$$begin{cases} x = acosh(sqrt{t}) \\ y = bsinh(sqrt{t}) end{cases}$$</div>
                <div class="math">$$d = sqrt{left(frac{x}{2}right)^2 + left(frac{y}{3}right)^2}$$</div>
            </div>
        </div>

        <!-- Controles de test -->
        <div class="test-section">
            <div class="row">
                <div class="col-md-3">
                    <button class="btn btn-primary w-100" onclick="testFunctions.runCompleteTest()">
                        Ejecutar Test Completo
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-success w-100" onclick="testFunctions.fixAllFormulas()">
                        Corregir Todas las Fórmulas
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-info w-100" onclick="testFunctions.addDynamicTests()">
                        Añadir Tests Dinámicos
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-warning w-100" onclick="testFunctions.reprocessMathJax()">
                        Re-procesar MathJax
                    </button>
                </div>
            </div>
        </div>
        
        <div id="test-results" class="mt-4"></div>
    </div>

    <script>
        window.testFunctions = {
            // Copiar todas las funciones de validación del archivo principal
            
            // Función específica para validar y corregir fórmulas con sqrt
            validateAndFixSqrtFormulas: function(element) {
                if (!element) return;
                
                const mathElements = element.querySelectorAll('.math, .math-equation, [class*="math"]');
                
                mathElements.forEach(mathEl => {
                    let content = mathEl.innerHTML;
                    let originalContent = content;
                    
                    if (content.includes('\\sqrt{') || content.includes('sqrt{') || content.includes('\\sqrt')) {
                        content = content
                            .replace(/\\\\sqrt\{/g, '\\sqrt{')
                            .replace(/(?<!\\)sqrt\{/g, '\\sqrt{')
                            .replace(/\\sqrt\s*\{/g, '\\sqrt{')
                            .replace(/\}\s*\}/g, '}}')
                            .replace(/\\sqrt([^{])/g, '\\sqrt{$1}')
                            .replace(/\\sqrt\{\}/g, '\\sqrt{0}');
                        
                        const openBraces = (content.match(/\{/g) || []).length;
                        const closeBraces = (content.match(/\}/g) || []).length;
                        
                        if (openBraces !== closeBraces) {
                            const difference = openBraces - closeBraces;
                            if (difference > 0) {
                                content += '}'.repeat(difference);
                            }
                        }
                        
                        if (content !== originalContent) {
                            mathEl.innerHTML = content;
                            console.log('Fórmula sqrt corregida:', originalContent, '->', content);
                        }
                    }
                });
            },
            
            // Función específica para validar y corregir fórmulas con begin{cases}
            validateAndFixCasesFormulas: function(element) {
                if (!element) return;
                
                const mathElements = element.querySelectorAll('.math, .math-equation, .parametric-equation, [class*="math"]');
                
                mathElements.forEach(mathEl => {
                    let content = mathEl.innerHTML;
                    let originalContent = content;
                    
                    if (content.includes('\\begin{cases}') || content.includes('begin{cases}') || content.includes('\\end{cases}') || content.includes('end{cases}')) {
                        content = content
                            .replace(/\\\\begin\{cases\}/g, '\\begin{cases}')
                            .replace(/\\\\end\{cases\}/g, '\\end{cases}')
                            .replace(/(?<!\\)begin\{cases\}/g, '\\begin{cases}')
                            .replace(/(?<!\\)end\{cases\}/g, '\\end{cases}')
                            .replace(/\\begin\s*\{cases\}/g, '\\begin{cases}')
                            .replace(/\\end\s*\{cases\}/g, '\\end{cases}')
                            .replace(/\\\\cosh/g, '\\cosh')
                            .replace(/\\\\sinh/g, '\\sinh')
                            .replace(/(?<!\\)cosh/g, '\\cosh')
                            .replace(/(?<!\\)sinh/g, '\\sinh');
                        
                        const beginMatches = (content.match(/\\begin\{cases\}/g) || []).length;
                        const endMatches = (content.match(/\\end\{cases\}/g) || []).length;
                        
                        if (beginMatches !== endMatches) {
                            const difference = beginMatches - endMatches;
                            if (difference > 0) {
                                content += '\\end{cases}'.repeat(difference);
                            }
                        }
                        
                        if (content !== originalContent) {
                            mathEl.innerHTML = content;
                            console.log('Fórmula cases corregida:', originalContent, '->', content);
                        }
                    }
                });
            },
            
            // Función para validar y corregir comandos matemáticos comunes
            validateAndFixCommonMathCommands: function(element) {
                if (!element) return;
                
                const mathElements = element.querySelectorAll('.math, .math-equation, .parametric-equation, [class*="math"]');
                
                mathElements.forEach(mathEl => {
                    let content = mathEl.innerHTML;
                    let originalContent = content;
                    
                    content = content
                        .replace(/(?<!\\)cos\(/g, '\\cos(')
                        .replace(/(?<!\\)sin\(/g, '\\sin(')
                        .replace(/(?<!\\)tan\(/g, '\\tan(')
                        .replace(/(?<!\\)cosh\(/g, '\\cosh(')
                        .replace(/(?<!\\)sinh\(/g, '\\sinh(')
                        .replace(/(?<!\\)tanh\(/g, '\\tanh(')
                        .replace(/(?<!\\)ln\(/g, '\\ln(')
                        .replace(/(?<!\\)log\(/g, '\\log(')
                        .replace(/(?<!\\)exp\(/g, '\\exp(')
                        .replace(/(?<!\\)frac\{/g, '\\frac{')
                        .replace(/(?<!\\)dfrac\{/g, '\\dfrac{')
                        .replace(/(?<!\\)left\(/g, '\\left(')
                        .replace(/(?<!\\)right\)/g, '\\right)')
                        .replace(/(?<!\\)left\[/g, '\\left[')
                        .replace(/(?<!\\)right\]/g, '\\right]');
                    
                    content = content
                        .replace(/\\\s+([a-zA-Z]+)/g, '\\$1')
                        .replace(/([a-zA-Z]+)\s*\{/g, '$1{')
                        .replace(/\{\s+/g, '{')
                        .replace(/\s+\}/g, '}');
                    
                    if (content !== originalContent) {
                        mathEl.innerHTML = content;
                        console.log('Comandos matemáticos corregidos:', originalContent, '->', content);
                    }
                });
            },
            
            // Función integral para validar y corregir todas las fórmulas matemáticas
            validateAndFixAllMathFormulas: function(element) {
                if (!element) return;
                
                console.log('Iniciando validación integral de fórmulas matemáticas...');
                
                this.validateAndFixSqrtFormulas(element);
                this.validateAndFixCasesFormulas(element);
                this.validateAndFixCommonMathCommands(element);
                
                console.log('Validación integral completada.');
                
                // Re-procesar con MathJax
                if (typeof MathJax !== "undefined" && MathJax.Hub) {
                    setTimeout(() => {
                        MathJax.Hub.Queue(["Typeset", MathJax.Hub, element]);
                    }, 100);
                }
            },
            
            runCompleteTest: function() {
                const results = document.getElementById('test-results');
                results.innerHTML = '<div class="alert alert-info">Ejecutando test completo...</div>';
                
                // Aplicar corrección a todo el documento
                this.validateAndFixAllMathFormulas(document.body);
                
                setTimeout(() => {
                    results.innerHTML += '<div class="alert alert-success">Test completo ejecutado. Revisa la consola para los logs detallados.</div>';
                }, 500);
            },
            
            fixAllFormulas: function() {
                this.validateAndFixAllMathFormulas(document.body);
                document.getElementById('test-results').innerHTML = 
                    '<div class="alert alert-success">Todas las fórmulas han sido corregidas. Revisa la consola para los detalles.</div>';
            },
            
            addDynamicTests: function() {
                const container = document.getElementById('test-results');
                const dynamicDiv = document.createElement('div');
                dynamicDiv.className = 'test-case fixed';
                dynamicDiv.innerHTML = `
                    <h4>Tests añadidos dinámicamente:</h4>
                    <div class="math">$$\\sqrt{begin{cases} x = sqrt{a} \\\\ y = sqrt{b} end{cases}}$$</div>
                    <div class="parametric-equation">$$begin{cases} x = cosh(sqrt{t}) \\\\ y = sinh(sqrt{t}) end{cases}$$</div>
                    <div class="math">$$f(x) = frac{sqrt{cos(x)}}{sinh(x)}$$</div>
                `;
                container.appendChild(dynamicDiv);
                
                setTimeout(() => {
                    this.validateAndFixAllMathFormulas(dynamicDiv);
                }, 100);
            },
            
            reprocessMathJax: function() {
                if (typeof MathJax !== "undefined" && MathJax.Hub) {
                    MathJax.Hub.Queue(["Typeset", MathJax.Hub, document.body]);
                    document.getElementById('test-results').innerHTML = 
                        '<div class="alert alert-info">MathJax re-procesado manualmente.</div>';
                }
            }
        };
        
        // Ejecutar corrección automática al cargar la página
        window.addEventListener('load', function() {
            setTimeout(() => {
                testFunctions.validateAndFixAllMathFormulas(document.body);
            }, 1500);
        });
    </script>
</body>
</html>
